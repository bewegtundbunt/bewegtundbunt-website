<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bewegt & bunt ‚Äì Generator</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#eef2f1;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --forest:#2D4A3E;
      --mint:#5AC08E;
      --shadow: 0 14px 45px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background: linear-gradient(180deg, #f3f6f5, var(--bg));
      color:var(--ink);
      padding:28px 16px 80px;
    }
    /* Seite erst anzeigen wenn Auth gecheckt */
    body.auth-loading { visibility: hidden; }

    .container{max-width: 980px; margin:0 auto}
    h1{margin:0 0 8px 0; font-size:34px}
    .sub{color:var(--muted); margin:0 0 18px 0}
    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:end;
    }
    @media (max-width: 760px){
      .form{grid-template-columns:1fr}
    }
    label{display:block; font-size:12px; letter-spacing:.02em; font-weight:800; margin:6px 0 6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-size:15px;
    }
    input:focus{border-color: rgba(90,192,142,.85); box-shadow: 0 0 0 4px rgba(90,192,142,.18)}
    .hint{font-size:12px; color:var(--muted); margin-top:4px}

    .btn{
      grid-column: 1 / -1;
      width:100%;
      border:none;
      padding:13px 14px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      background: var(--forest);
      color:white;
      font-size:16px;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .msg{
      margin-top:14px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:14px;
      display:none;
    }
    .msg.ok{border-color:rgba(90,192,142,.55); background: rgba(90,192,142,.12); color:#064e3b}
    .msg.err{border-color:rgba(224,122,95,.55); background: rgba(224,122,95,.10); color:#7c2d12}

    .section{margin-top:18px}
    .box{
      background:#fbfffe;
      border:1px solid rgba(45,74,62,.18);
      border-radius:16px;
      padding:14px 14px;
      margin-top:14px;
    }
    .box h3{margin:0 0 10px 0; font-size:15px; letter-spacing:.02em}
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 860px){ .grid4{grid-template-columns: repeat(2, 1fr);} }
    .mini{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:12px;
      background:white;
    }
    .mini .big{font-size:22px; font-weight:900; color: var(--forest)}
    .mini .lab{font-size:12px; color:var(--muted)}
    ul{margin:8px 0 0 18px}
    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:14px;
      gap:12px;
    }
    .linkbtn{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    .linkbtn:hover{filter:brightness(0.98)}
    .user-email{
      font-size:13px;
      color:var(--muted);
      padding:8px 12px;
      background:rgba(0,0,0,.04);
      border-radius:10px;
    }
    code.small{font-size:12px}
  </style>
</head>

<body class="auth-loading">
  <div class="container">

    <div class="topbar">
      <div>
        <h1>üèÉ‚Äç‚ôÄÔ∏è Bewegungsstunde erstellen</h1>
        <p class="sub">bewegt &amp; bunt ‚Äì KI-gest√ºtzter Stundenplan-Generator</p>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span id="userEmail" class="user-email"></span>
        <button id="logoutBtn" class="linkbtn">Abmelden</button>
      </div>
    </div>

    <div class="card">
      <div class="form">
        <div>
          <label for="templateKey">TEMPLATE-KEY</label>
          <input id="templateKey" value="bewegung_basis" />
          <div class="hint">Beispiel: <code class="small">bewegung_basis</code></div>
        </div>

        <div>
          <label for="minutes">ZIELDAUER (MINUTEN)</label>
          <input id="minutes" type="number" min="10" max="120" value="30" />
          <div class="hint">z.B. 30</div>
        </div>

        <button id="goBtn" class="btn">Stunde generieren</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <div id="result" class="section" style="display:none;">
      <div class="box">
        <h3>üìã √úBERSICHT</h3>
        <div class="grid4" id="overview"></div>
      </div>

      <div class="box">
        <h3>üõ†Ô∏è VORBEREITUNG</h3>
        <ul id="prep"></ul>
      </div>

      <div class="box">
        <h3>üéí MATERIAL</h3>
        <ul id="materials"></ul>
      </div>

      <div class="box">
        <h3>‚è±Ô∏è ABLAUF</h3>
        <div id="flow"></div>
      </div>
    </div>

  </div>

<script>
  const SUPABASE_URL = "https://jhgoqrinhdtowuhzirnf.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_uu0Xh8f_71Dk1qAQ_UirpQ_u-P4eSBG";

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const msgBox = document.getElementById("msg");
  const resWrap = document.getElementById("result");

  // ‚îÄ‚îÄ‚îÄ Auth Guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Seite ist unsichtbar bis Auth gecheckt (verhindert Flash of content)
  (async () => {
    const { data: { session } } = await sb.auth.getSession();

    if (!session) {
      // Kein Login ‚Üí sofort weg
      window.location.replace("login.html");
      return;
    }

    // Eingeloggt ‚Üí E-Mail anzeigen, Seite sichtbar machen
    document.getElementById("userEmail").textContent = session.user.email;
    document.body.classList.remove("auth-loading");

    // Session-√Ñnderungen √ºberwachen (z.B. Logout in anderem Tab)
    sb.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) {
        window.location.replace("login.html");
      }
    });
  })();

  // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showMsg(text, type){
    msgBox.textContent = text;
    msgBox.className = "msg " + (type || "");
    msgBox.style.display = "block";
  }

  function clearMsg(){
    msgBox.style.display = "none";
    msgBox.textContent = "";
  }

  function li(text){
    const el = document.createElement("li");
    el.textContent = text;
    return el;
  }

  function renderResult(payload){
    const data = payload?.data ?? payload ?? {};

    // Felder laut generate_session_print_v2 Struktur
    const age      = data?.meta?.age_group ?? "‚Äì";
    const duration = data?.meta?.total_duration_min ?? "‚Äì";
    const room     = data?.meta?.space ?? "‚Äì";
    const intensity = data?.meta?.avg_intensity_level
      ? Number(data.meta.avg_intensity_level).toFixed(1)
      : "‚Äì";

    const overview = document.getElementById("overview");
    overview.innerHTML = "";

    const cards = [
      { big: age, lab: "Altersgruppe" },
      { big: duration + " min", lab: "Gesamtdauer" },
      { big: room, lab: "Raum" },
      { big: intensity, lab: "√ò Intensit√§t" },
    ];

    cards.forEach(c => {
      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `<div class="big">${c.big}</div><div class="lab">${c.lab}</div>`;
      overview.appendChild(div);
    });

    // Vorbereitung (setup_steps)
    const prep = document.getElementById("prep");
    prep.innerHTML = "";
    (data?.setup_steps ?? []).forEach(x => prep.appendChild(li(x)));

    // Material
    const mats = document.getElementById("materials");
    mats.innerHTML = "";
    (data?.materials ?? []).forEach(x => mats.appendChild(li(
      typeof x === "string" ? x : JSON.stringify(x)
    )));

    // Ablauf (timeline)
    const flow = document.getElementById("flow");
    flow.innerHTML = "";

    (data?.timeline ?? []).forEach(s => {
      const wrap = document.createElement("div");
      wrap.className = "mini";
      wrap.style.marginBottom = "10px";

      const title = s.title ?? s.slot_type ?? "Sequenz";
      const timeStr = s.t_start_min !== undefined
        ? `${s.t_start_min}‚Äì${s.t_end_min} min`
        : (s.duration_min ? s.duration_min + " min" : "");
      const desc = s.content ?? "";

      wrap.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:baseline;">
          <div style="font-weight:900">${title}</div>
          <div style="color:var(--muted);font-weight:800">${timeStr}</div>
        </div>
        <div style="margin-top:6px;color:#334155;line-height:1.45">${desc}</div>
      `;
      flow.appendChild(wrap);
    });

    resWrap.style.display = "block";
  }

  // ‚îÄ‚îÄ‚îÄ Generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById("goBtn").addEventListener("click", async () => {
    clearMsg();

    // Nochmal Session pr√ºfen bevor API-Call
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
      window.location.replace("login.html");
      return;
    }

    const template_key = document.getElementById("templateKey").value.trim();
    const target_minutes = Number(document.getElementById("minutes").value || 30);

    if (!template_key) {
      showMsg("Bitte einen TEMPLATE-KEY eingeben.", "err");
      return;
    }

    document.getElementById("goBtn").disabled = true;
    showMsg("Generiere Stunde‚Ä¶", "");

    try {
      const { data, error } = await sb.rpc("generate_session_print_v2", {
        p_template_key: template_key,
        p_target_minutes: target_minutes
      });

      if (error) {
        showMsg("Fehler: " + error.message, "err");
        return;
      }

      // ‚îÄ‚îÄ Nutzung loggen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      await sb.from("usage_log").insert({
        user_id: session.user.id,
        user_email: session.user.email,
        template_key,
        target_minutes
      });

      showMsg("‚úÖ Stunde erfolgreich generiert!", "ok");
      renderResult(data);

    } catch(e) {
      showMsg("Unerwarteter Fehler: " + (e?.message || e), "err");
    } finally {
      document.getElementById("goBtn").disabled = false;
    }
  });

  // ‚îÄ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await sb.auth.signOut();
    window.location.replace("login.html");
  });
</script>

</body>
</html>
