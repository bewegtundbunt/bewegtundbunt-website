<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>bewegt & bunt – Bewegungsangebote</title>
  <meta name="description" content="Bereich wählen → Dauer wählen → Bewegungsangebote aufrufen." />

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --soft:#f8fafc;
      --brand:#1a5c4e;
      --brand2:#2a7a67;
      --accent:#c9a84c;
      --danger:#b42318;

      --radius:18px;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --shadow2: 0 6px 18px rgba(2,6,23,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg, #ffffff 0%, #f7fbf9 60%, #ffffff 100%);
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height:1.35;
    }

    a{color:inherit; text-decoration:none}
    button{font:inherit}

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:28px 18px 60px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      padding:18px 18px;
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(6px);
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:260px;
    }

    .logo{
      width:46px; height:46px;
      border-radius:14px;
      background: radial-gradient(circle at 30% 30%, #2a7a67 0%, #1a5c4e 55%, #13473d 100%);
      display:grid;
      place-items:center;
      color:#fff;
      font-weight:800;
      letter-spacing:.5px;
      box-shadow: 0 10px 18px rgba(26,92,78,.18);
    }

    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .top-actions{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      gap:10px;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      box-shadow: 0 2px 0 rgba(15,23,42,.02);
      font-size:13px;
      color:var(--muted);
    }

    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--brand2);
      box-shadow: 0 0 0 4px rgba(42,122,103,.12);
    }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s box-shadow, .15s border-color;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
      font-weight:650;
      color:var(--ink);
    }
    .btn:hover{ transform: translateY(-1px); border-color:#cbd5e1; }
    .btn:active{ transform: translateY(0px); box-shadow: none; }

    .btn.primary{
      background: linear-gradient(180deg, #2a7a67, #1a5c4e);
      color:#fff;
      border-color: transparent;
      box-shadow: 0 12px 24px rgba(26,92,78,.22);
    }

    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    @media (max-width: 940px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }

    .card h2{
      margin:0 0 8px;
      font-size:16px;
    }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
    }

    .step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border-radius:16px;
      background: var(--soft);
      border:1px dashed #dbeafe;
      margin-top:12px;
    }
    .badge{
      min-width:28px;
      height:28px;
      border-radius:10px;
      background: rgba(26,92,78,.12);
      color: var(--brand);
      display:grid;
      place-items:center;
      font-weight:800;
      margin-top:2px;
    }
    .step strong{display:block; font-size:13px;}
    .step span{display:block; font-size:12px; color:var(--muted); margin-top:2px;}

    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:14px;
    }

    .choice{
      text-align:left;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      transition:.15s transform, .15s border-color, .15s box-shadow;
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .choice:hover{ transform: translateY(-1px); border-color:#cbd5e1; }
    .choice:active{ transform: translateY(0px); box-shadow:none; }
    .choice .meta{display:flex; flex-direction:column; gap:3px;}
    .choice .meta b{font-size:14px;}
    .choice .meta small{color:var(--muted); font-size:12px;}
    .arrow{
      width:28px; height:28px; border-radius:10px;
      background: rgba(201,168,76,.18);
      display:grid; place-items:center;
      color:#7a5f1a;
      font-weight:900;
    }

    .panel-title{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .panel-title h2{margin:0; font-size:18px;}
    .crumbs{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }

    .searchbar{
      margin:12px 0 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .input{
      flex:1;
      min-width:220px;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      box-shadow: 0 10px 18px rgba(2,6,23,.03);
    }
    .input:focus{ border-color: rgba(42,122,103,.6); box-shadow: 0 0 0 4px rgba(42,122,103,.12); }

    .list{
      display:grid;
      gap:10px;
      margin-top:8px;
    }

    .item{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      box-shadow: 0 10px 22px rgba(2,6,23,.04);
    }
    .item h3{
      margin:0;
      font-size:15px;
    }
    .item p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .tags{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      font-size:12px;
      color: var(--brand);
      background: rgba(26,92,78,.10);
      border:1px solid rgba(26,92,78,.14);
      padding:6px 10px;
      border-radius:999px;
      font-weight:650;
    }

    .mini{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #fff;
      color: var(--muted);
      font-weight:650;
    }

    .empty{
      padding:16px;
      border-radius:18px;
      border:1px dashed #cbd5e1;
      background: rgba(248,250,252,.75);
      color: var(--muted);
      font-size:13px;
    }

    .detail{
      border-top:1px solid var(--line);
      margin-top:14px;
      padding-top:14px;
    }
    .detail h3{margin:0; font-size:16px;}
    .detail .meta{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .hr{
      height:1px; background: var(--line);
      margin:14px 0;
    }

    footer{
      margin-top:16px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }

    .warn{
      border:1px solid rgba(180,35,24,.22);
      background: rgba(180,35,24,.06);
      color:#7a1b16;
      padding:12px 12px;
      border-radius:16px;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">BB</div>
        <div>
          <h1>bewegt &amp; bunt</h1>
          <p>Bereich wählen → Dauer wählen → Angebote aufrufen</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="statusPill" title="Aktueller Auswahlstatus">
          <span class="dot"></span>
          <span id="statusText">Bitte Bereich wählen</span>
        </div>
        <button class="btn ghost" id="btnHome" type="button">Start</button>
        <button class="btn" id="btnBack" type="button">Zurück</button>
        <button class="btn primary" id="btnRegenerate" type="button" title="Simuliert: neu generiert aus hinterlegten Dateien">
          Neu generieren
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Steps / Auswahl -->
      <aside class="card" id="leftPanel">
        <h2>Navigation</h2>
        <p class="sub">Wähle dich durch den Ablauf. Du kannst jederzeit zurück.</p>

        <div class="step">
          <div class="badge">1</div>
          <div>
            <strong>Bereich auswählen</strong>
            <span>Krippe oder Kindergarten</span>
          </div>
        </div>

        <div class="step">
          <div class="badge">2</div>
          <div>
            <strong>Dauer wählen</strong>
            <span>im Kindergarten: 45 oder 60 Minuten</span>
          </div>
        </div>

        <div class="step">
          <div class="badge">3</div>
          <div>
            <strong>Angebot öffnen</strong>
            <span>Liste aus den hinterlegten Einträgen</span>
          </div>
        </div>

        <div class="hr"></div>

        <div id="choicesArea" class="choices"></div>

        <div class="hr"></div>

        <div class="warn">
          Hinweis: „Neu generieren“ mischt/rotiert die Angebote (Platzhalter für „aus Systemdateien neu erzeugen“).
          Später kannst du hier Supabase/Server anbinden.
        </div>
      </aside>

      <!-- RIGHT: Content -->
      <main class="card" id="mainPanel">
        <div class="panel-title">
          <div>
            <h2 id="viewTitle">Start</h2>
            <div class="crumbs" id="crumbs">—</div>
          </div>
          <div class="mini">
            <span class="chip" id="chipArea">Bereich: —</span>
            <span class="chip" id="chipDuration">Dauer: —</span>
          </div>
        </div>

        <div class="searchbar">
          <input class="input" id="search" type="search" placeholder="Suche (z. B. 'Tücher', 'Kegel', 'Aufwärmen') …" />
          <button class="btn" id="btnClearSearch" type="button">Leeren</button>
        </div>

        <div id="content"></div>

        <footer>
          © <span id="year"></span> bewegt &amp; bunt — Struktur: Bereich → Dauer → Angebote
        </footer>
      </main>
    </div>
  </div>

<script>
/**
 * 1) HIER HINTERLEGST DU DEINE "DATEIEN"/ANGEBOTE
 *    Später kannst du DATA aus Supabase / JSON-Dateien / Backend laden.
 */
const DATA = {
  krippe: {
    // Bei Krippe kannst du entweder direkt Angebote zeigen (ohne 45/60),
    // oder optional ebenfalls Zeiten hinzufügen. Hier: direkt.
    offers: [
      {
        id: "k1",
        title: "Krippe: Fühl-Parcours (10–12 Min)",
        teaser: "Sanftes Bewegen, Tasten & Gleichgewicht für die Kleinsten.",
        duration: 12,
        tags: ["Krippe", "Sensorik", "Parcours"],
        content: {
          ziel: "Körperwahrnehmung & sichere Bewegungserfahrungen.",
          material: "Weiche Matten, Kissen, 2–3 kleine Gegenstände mit Struktur (z. B. Igelball).",
          aufbau: "Matten als Inseln, Kissen als Mini-Hügel, ein kurzer Weg dazwischen.",
          ablauf: [
            "Begrüßung im Kreis (1 Min): Klatschen & Winken.",
            "Warm-up (2 Min): 'Wolke pusten' – tief ein/aus, Arme hoch/runter.",
            "Parcours (7 Min): Insel zu Insel krabbeln/gehen, zwischendurch fühlen/tasten.",
            "Cool-down (2 Min): Kuschelkissen – langsam schaukeln, ruhig werden."
          ]
        }
      },
      {
        id: "k2",
        title: "Krippe: Tücher-Tanz (8–10 Min)",
        teaser: "Musik + Tücher: Schwingen, werfen, fangen, verstecken.",
        duration: 10,
        tags: ["Krippe", "Tücher", "Rhythmus"],
        content: {
          ziel: "Rhythmusgefühl, Armkoordination, Freude an Bewegung.",
          material: "Leichte Tücher, Musik (Handy/Box).",
          aufbau: "Freie Fläche, jedes Kind ein Tuch.",
          ablauf: [
            "Startsignal: Musik an – Tuch hoch/tief.",
            "Tuch-Welle: groß/klein, schnell/langsam.",
            "Tuch-Versteck: kurz über den Kopf – 'Wo bin ich?'",
            "Abschluss: Musik aus – Tuch zusammenlegen & winken."
          ]
        }
      },
      {
        id: "k3",
        title: "Krippe: Mini-Ballreise (12–15 Min)",
        teaser: "Rollen, schieben, stoppen – einfache Ballspiele.",
        duration: 15,
        tags: ["Krippe", "Ball", "Koordination"],
        content: {
          ziel: "Hand-Auge-Koordination & gemeinsames Spiel.",
          material: "Weiche Bälle (Schaumstoff), ggf. kleine Markierungen.",
          aufbau: "Kinder sitzen im Halbkreis.",
          ablauf: [
            "Ball begrüßen: Ball in beiden Händen drücken (Sensorik).",
            "Ball rollen: zu einer Bezugsperson und zurück.",
            "Ball stoppen: mit zwei Händen anhalten.",
            "Ballreise: Ball einmal reihum rollen (mit Hilfe)."
          ]
        }
      }
    ]
  },

  kindergarten: {
    durations: {
      45: [
        {
          id: "g45_1",
          title: "Abenteuer im Dschungel (45 Min)",
          teaser: "Klettern, Springen, Balancieren – mit klarer Story.",
          duration: 45,
          tags: ["Kindergarten", "Parcours", "Story"],
          content: {
            ziel: "Ganzkörperkoordination, Mut & Zusammenarbeit.",
            material: "Bänke, Matten, Reifen, Seile, 4–6 Kegel.",
            aufbau: "Stationen als 'Dschungelpfad' (Balancierbank, Reifenfluss, Mattenberg).",
            ablauf: [
              "Einstieg (5): Dschungel-Geräusche & Aufwärmen (Tiere nachmachen).",
              "Hauptteil (30): Stationsparcours in Gruppen, Wechsel alle 5–6 Minuten.",
              "Spiel (7): 'Kegel-Schlangen' – schnell, aber kontrolliert laufen.",
              "Cool-down (3): Rücken auf Matte, ruhige Atmung, Abschlusskreis."
            ]
          }
        },
        {
          id: "g45_2",
          title: "Tücher & Kegel – Farbauftrag (45 Min)",
          teaser: "Bewegung mit Materialwahl: Ziehen, tragen, zielen, Teamaufgaben.",
          duration: 45,
          tags: ["Kindergarten", "Tücher", "Kegel", "Team"],
          content: {
            ziel: "Teamarbeit, Zielwerfen, Raumorientierung.",
            material: "Tücher, Kegel, 2 Körbe/Markierungen.",
            aufbau: "2–3 Zonen (Start, Sammelzone, Zielzone).",
            ablauf: [
              "Warm-up (7): 'Farbwechsel' – bei Farbe die Zone wechseln.",
              "Aufgabe (25): Tücher transportieren (nicht fallen lassen), Kegel in Zielzone sammeln.",
              "Spiel (10): Kegel-Zielwurf (sanft, Regeln klar).",
              "Abschluss (3): kurzes Feedback im Kreis."
            ]
          }
        }
      ],
      60: [
        {
          id: "g60_1",
          title: "Piratenprüfung (60 Min)",
          teaser: "Großer Parcours + Teammissionen + Schatzmoment.",
          duration: 60,
          tags: ["Kindergarten", "Parcours", "Team", "Story"],
          content: {
            ziel: "Ausdauer, Mut, Kooperation, Körperkontrolle.",
            material: "Matten, Bänke, Reifen, Seil, kleine 'Schätze' (Karten/Bälle).",
            aufbau: "Parcours als Inseln: Brücke, Wasser, Höhle, Schatzplatz.",
            ablauf: [
              "Einstieg (8): Piratenbewegungen (rudern, ausweichen, springen).",
              "Technik (10): Balancieren & sicheres Springen üben.",
              "Hauptteil (30): Missionen in Teams – Schätze holen, Regeln einhalten.",
              "Spiel (8): 'Haifisch' – Fangspiel mit Sicherheitszonen.",
              "Cool-down (4): Schatz teilen, ruhig werden, Abschluss."
            ]
          }
        },
        {
          id: "g60_2",
          title: "Riesenbaustelle (60 Min)",
          teaser: "Bauen, bewegen, koordinieren – mit Rollen & Aufgaben.",
          duration: 60,
          tags: ["Kindergarten", "Kegel", "Organisation", "Rollen"],
          content: {
            ziel: "Planen, koordinieren, Bewegung mit Sinnauftrag.",
            material: "Kegel, Seile, Reifen, Baukarten (Papier).",
            aufbau: "Baustellen-Zonen: Lager, Transport, Baustelle, Kontrolle.",
            ablauf: [
              "Warm-up (10): 'Maschinen' – Bewegungen im Kreis, Tempo variieren.",
              "Hauptteil (35): Stationen: transportieren, sortieren, bauen, prüfen.",
              "Spiel (10): Team-Staffel mit Material (Sicherheit!).",
              "Abschluss (5): Bauwerk anschauen, Feedback."
            ]
          }
        }
      ]
    }
  }
};

/**
 * 2) STATE + "ROUTING" (hash-basiert)
 * Views:
 * - #/area
 * - #/duration
 * - #/list
 * - #/detail?id=...
 */
const state = {
  area: null,        // 'krippe' | 'kindergarten'
  duration: null,    // 45 | 60 | null
  lastListSeed: 0,   // for regeneration simulation
  search: ""
};

const $ = (sel) => document.querySelector(sel);

const ui = {
  choicesArea: $("#choicesArea"),
  viewTitle: $("#viewTitle"),
  crumbs: $("#crumbs"),
  chipArea: $("#chipArea"),
  chipDuration: $("#chipDuration"),
  content: $("#content"),
  statusText: $("#statusText"),
  btnHome: $("#btnHome"),
  btnBack: $("#btnBack"),
  btnRegenerate: $("#btnRegenerate"),
  search: $("#search"),
  btnClearSearch: $("#btnClearSearch"),
};

function saveState(){
  localStorage.setItem("bb_nav_state_v1", JSON.stringify(state));
}

function loadState(){
  try{
    const raw = localStorage.getItem("bb_nav_state_v1");
    if(!raw) return;
    const parsed = JSON.parse(raw);
    Object.assign(state, parsed);
  }catch(e){}
}

function setHash(path){
  if(location.hash !== path) location.hash = path;
}

function parseHash(){
  const h = location.hash || "#/area";
  const [path, qs] = h.split("?");
  const params = new URLSearchParams(qs || "");
  return { path, params };
}

function updateTopStatus(){
  const areaLabel = state.area ? (state.area === "krippe" ? "Krippe" : "Kindergarten") : "—";
  const durLabel = state.duration ? `${state.duration} Min` : "—";

  ui.chipArea.textContent = `Bereich: ${areaLabel}`;
  ui.chipDuration.textContent = `Dauer: ${durLabel}`;

  let status = "Bitte Bereich wählen";
  if(state.area && state.area === "krippe") status = "Krippe: Angebote auswählen";
  if(state.area && state.area === "kindergarten" && !state.duration) status = "Kindergarten: Dauer wählen";
  if(state.area && state.area === "kindergarten" && state.duration) status = "Angebote auswählen";
  ui.statusText.textContent = status;

  ui.btnRegenerate.disabled = !(state.area && (state.area === "krippe" || (state.area === "kindergarten" && state.duration)));
  ui.btnRegenerate.style.opacity = ui.btnRegenerate.disabled ? .55 : 1;
  ui.btnRegenerate.style.cursor = ui.btnRegenerate.disabled ? "not-allowed" : "pointer";
}

function crumbsText(){
  const a = state.area ? (state.area === "krippe" ? "Krippe" : "Kindergarten") : "Bereich";
  if(!state.area) return "Bereich wählen";
  if(state.area === "krippe") return "Bereich → Krippe → Angebote";
  if(state.area === "kindergarten" && !state.duration) return "Bereich → Kindergarten → Dauer";
  if(state.area === "kindergarten" && state.duration) return `Bereich → Kindergarten → ${state.duration} Min → Angebote`;
  return a;
}

/**
 * 3) DATA HELPERS
 */
function getOffers(){
  if(state.area === "krippe"){
    return DATA.krippe.offers.slice();
  }
  if(state.area === "kindergarten" && state.duration){
    const arr = DATA.kindergarten.durations[String(state.duration)] || [];
    return arr.slice();
  }
  return [];
}

function normalize(str){
  return String(str || "").toLowerCase().trim();
}

function matchesSearch(offer, q){
  if(!q) return true;
  const hay = [
    offer.title,
    offer.teaser,
    (offer.tags || []).join(" "),
    offer.content?.ziel,
    offer.content?.material,
    offer.content?.aufbau,
    (offer.content?.ablauf || []).join(" ")
  ].join(" ");
  return normalize(hay).includes(normalize(q));
}

/**
 * "Neu generieren" Simulation:
 * - Erhöht seed
 * - Rotiert Liste oder mischt leicht (deterministisch per seed)
 */
function regenerateOffers(offers){
  const seed = state.lastListSeed || 0;
  const n = offers.length;
  if(n <= 1) return offers;

  // leichte Rotation + pseudo-shuffle
  const rot = (seed + 1) % n;
  const rotated = offers.slice(rot).concat(offers.slice(0, rot));

  // pseudo shuffle (linear congruential)
  let x = (seed + 17) * 1103515245 + 12345;
  const out = rotated.slice();
  for(let i = out.length - 1; i > 0; i--){
    x = (x * 1103515245 + 12345) >>> 0;
    const j = x % (i + 1);
    [out[i], out[j]] = [out[j], out[i]];
  }
  return out;
}

function findOfferById(id){
  const all = [
    ...DATA.krippe.offers,
    ...Object.values(DATA.kindergarten.durations).flat()
  ];
  return all.find(o => o.id === id) || null;
}

/**
 * 4) RENDER LEFT CHOICES (immer passend zur View)
 */
function renderChoicesForArea(){
  ui.choicesArea.innerHTML = `
    <button class="choice" type="button" data-area="krippe">
      <span class="meta">
        <b>Krippe</b>
        <small>Direkt zu kurzen Angeboten</small>
      </span>
      <span class="arrow">›</span>
    </button>

    <button class="choice" type="button" data-area="kindergarten">
      <span class="meta">
        <b>Kindergarten</b>
        <small>Dauer wählen (45 / 60 Minuten)</small>
      </span>
      <span class="arrow">›</span>
    </button>
  `;

  ui.choicesArea.querySelectorAll("[data-area]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.area = btn.getAttribute("data-area");
      state.duration = null;
      state.search = "";
      ui.search.value = "";
      saveState();
      if(state.area === "krippe") setHash("#/list");
      else setHash("#/duration");
    });
  });
}

function renderChoicesForDuration(){
  ui.choicesArea.innerHTML = `
    <button class="choice" type="button" data-duration="45">
      <span class="meta">
        <b>45 Minuten</b>
        <small>Bewegungsangebote (45)</small>
      </span>
      <span class="arrow">›</span>
    </button>

    <button class="choice" type="button" data-duration="60">
      <span class="meta">
        <b>60 Minuten</b>
        <small>Bewegungsangebote (60)</small>
      </span>
      <span class="arrow">›</span>
    </button>
  `;

  ui.choicesArea.querySelectorAll("[data-duration]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.duration = Number(btn.getAttribute("data-duration"));
      state.search = "";
      ui.search.value = "";
      saveState();
      setHash("#/list");
    });
  });
}

function renderChoicesForList(){
  // Quick navigation buttons
  const a = state.area === "krippe" ? "Krippe" : "Kindergarten";
  const d = state.duration ? `${state.duration} Min` : "—";

  ui.choicesArea.innerHTML = `
    <button class="choice" type="button" id="goArea">
      <span class="meta">
        <b>Bereich ändern</b>
        <small>Aktuell: ${a}</small>
      </span>
      <span class="arrow">↺</span>
    </button>

    ${state.area === "kindergarten" ? `
      <button class="choice" type="button" id="goDuration">
        <span class="meta">
          <b>Dauer ändern</b>
          <small>Aktuell: ${d}</small>
        </span>
        <span class="arrow">↺</span>
      </button>
    ` : ""}

    <div class="empty" style="margin-top:8px;">
      Tipp: Nutze die Suche rechts, um Material/Themen schnell zu finden.
    </div>
  `;

  $("#goArea").addEventListener("click", ()=>{
    state.area = null;
    state.duration = null;
    state.search = "";
    ui.search.value = "";
    saveState();
    setHash("#/area");
  });

  const goDur = $("#goDuration");
  if(goDur){
    goDur.addEventListener("click", ()=>{
      state.duration = null;
      state.search = "";
      ui.search.value = "";
      saveState();
      setHash("#/duration");
    });
  }
}

function renderChoicesForDetail(){
  ui.choicesArea.innerHTML = `
    <button class="choice" type="button" id="backToList">
      <span class="meta">
        <b>Zurück zur Liste</b>
        <small>Alle Angebote anzeigen</small>
      </span>
      <span class="arrow">‹</span>
    </button>
    <div class="empty" style="margin-top:8px;">
      Du kannst rechts drucken oder später einen PDF-Export ergänzen.
    </div>
  `;
  $("#backToList").addEventListener("click", ()=> setHash("#/list"));
}

/**
 * 5) RENDER MAIN CONTENT (views)
 */
function renderAreaView(){
  ui.viewTitle.textContent = "Wähle einen Bereich aus";
  ui.crumbs.textContent = "Bereich → (Krippe | Kindergarten)";
  ui.content.innerHTML = `
    <div class="empty">
      Bitte wähle links einen Bereich. <br />
      <b>Krippe</b> führt direkt zu kurzen Angeboten. <br />
      <b>Kindergarten</b> führt zur Auswahl <b>45/60 Minuten</b>.
    </div>
  `;
  renderChoicesForArea();
}

function renderDurationView(){
  ui.viewTitle.textContent = "Kindergarten: Dauer wählen";
  ui.crumbs.textContent = "Bereich → Kindergarten → Dauer";
  ui.content.innerHTML = `
    <div class="empty">
      Bitte wähle links, ob du <b>45</b> oder <b>60 Minuten</b> Angebote öffnen möchtest.
    </div>
  `;
  renderChoicesForDuration();
}

function renderListView(){
  ui.viewTitle.textContent = "Bewegungsangebote";
  ui.crumbs.textContent = crumbsText();

  let offers = getOffers();

  // Apply regeneration seed (optional)
  offers = regenerateOffers(offers);

  // Apply search
  const q = state.search || "";
  const filtered = offers.filter(o => matchesSearch(o, q));

  if(!state.area || (state.area==="kindergarten" && !state.duration)){
    ui.content.innerHTML = `
      <div class="empty">
        Es fehlt noch eine Auswahl. Bitte links den Ablauf fortsetzen.
      </div>
    `;
    renderChoicesForArea();
    return;
  }

  if(filtered.length === 0){
    ui.content.innerHTML = `
      <div class="empty">
        Keine Treffer für „<b>${escapeHtml(q)}</b>“. <br/>
        Tipp: Suche nach Material (z. B. <i>Tücher</i>, <i>Kegel</i>) oder Thema (z. B. <i>Parcours</i>).
      </div>
    `;
    renderChoicesForList();
    return;
  }

  const listHtml = filtered.map(o => `
    <div class="item">
      <div>
        <h3>${escapeHtml(o.title)}</h3>
        <p>${escapeHtml(o.teaser || "")}</p>
        <div class="tags">
          ${(o.tags || []).slice(0,5).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
        </div>
      </div>
      <div class="mini">
        <span class="chip">${o.duration ? `${o.duration} Min` : ""}</span>
        <button class="btn" type="button" data-open="${escapeAttr(o.id)}">Öffnen</button>
      </div>
    </div>
  `).join("");

  ui.content.innerHTML = `
    <div class="empty" style="margin-bottom:10px;">
      ${state.area === "krippe"
        ? `Du siehst gerade <b>Krippe</b>-Angebote.`
        : `Du siehst gerade <b>Kindergarten</b>-Angebote für <b>${state.duration} Minuten</b>.`
      }
      Die Reihenfolge bleibt stabil – „Neu generieren“ simuliert neue Kombinationen aus hinterlegten Einträgen.
    </div>
    <div class="list">${listHtml}</div>
  `;

  ui.content.querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-open");
      setHash(`#/detail?id=${encodeURIComponent(id)}`);
    });
  });

  renderChoicesForList();
}

function renderDetailView(id){
  const offer = findOfferById(id);

  if(!offer){
    ui.viewTitle.textContent = "Nicht gefunden";
    ui.crumbs.textContent = crumbsText();
    ui.content.innerHTML = `
      <div class="empty">
        Dieses Angebot existiert nicht (mehr). Zurück zur Liste.
      </div>
    `;
    renderChoicesForDetail();
    return;
  }

  ui.viewTitle.textContent = offer.title;
  ui.crumbs.textContent = crumbsText();

  const c = offer.content || {};
  const ablauf = Array.isArray(c.ablauf) ? c.ablauf : [];

  ui.content.innerHTML = `
    <div class="item" style="align-items:stretch;">
      <div style="flex:1;">
        <h3>${escapeHtml(offer.title)}</h3>
        <p>${escapeHtml(offer.teaser || "")}</p>

        <div class="tags">
          ${(offer.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
        </div>

        <div class="detail">
          <h3>Inhalt</h3>
          <div class="meta">
            ${offer.duration ? `<span class="chip">Dauer: ${offer.duration} Min</span>` : ""}
            ${c.ziel ? `<span class="chip">Ziel: ${escapeHtml(c.ziel)}</span>` : ""}
          </div>

          ${c.material ? `
            <div class="hr"></div>
            <b>Material</b>
            <p>${escapeHtml(c.material)}</p>
          ` : ""}

          ${c.aufbau ? `
            <div class="hr"></div>
            <b>Aufbau</b>
            <p>${escapeHtml(c.aufbau)}</p>
          ` : ""}

          ${ablauf.length ? `
            <div class="hr"></div>
            <b>Ablauf</b>
            <ol>
              ${ablauf.map(step => `<li style="margin:8px 0; color: var(--ink);">
                <span style="color: var(--muted);">${escapeHtml(step)}</span>
              </li>`).join("")}
            </ol>
          ` : ""}

          <div class="hr"></div>
          <button class="btn" id="btnPrint" type="button">Drucken</button>
        </div>
      </div>
      <div style="width:240px; min-width:240px; display:flex; flex-direction:column; gap:10px;">
        <div class="empty">
          <b>Tipp</b><br/>
          Wenn du später wirklich „aus Dateien neu generieren“ willst, ersetzen wir die DATA-Liste durch:
          <br/>• Supabase Tabelle<br/>• Storage/JSON<br/>• oder API Endpoint
        </div>
        <div class="empty">
          <b>Für Pilot</b><br/>
          Diese Seite ist ideal, um fertige Einheiten stabil auszuliefern.
        </div>
      </div>
    </div>
  `;

  $("#btnPrint").addEventListener("click", ()=> window.print());
  renderChoicesForDetail();
}

/**
 * 6) Router
 */
function render(){
  updateTopStatus();

  const { path, params } = parseHash();

  ui.crumbs.textContent = crumbsText();

  // ensure coherent navigation
  if(path === "#/duration" && state.area !== "kindergarten"){
    state.area = "kindergarten";
    saveState();
  }

  // toggle search bar presence (still visible but meaningful)
  ui.search.disabled = (path === "#/area" || path === "#/duration");
  ui.search.style.opacity = ui.search.disabled ? .6 : 1;

  if(path === "#/area"){
    state.area = null;
    state.duration = null;
    saveState();
    renderAreaView();
    return;
  }

  if(path === "#/duration"){
    state.area = "kindergarten";
    state.duration = null;
    saveState();
    renderDurationView();
    return;
  }

  if(path === "#/list"){
    renderListView();
    return;
  }

  if(path === "#/detail"){
    const id = params.get("id");
    renderDetailView(id);
    return;
  }

  // default
  setHash("#/area");
}

/**
 * 7) Events
 */
ui.btnHome.addEventListener("click", ()=> setHash("#/area"));

ui.btnBack.addEventListener("click", ()=>{
  const { path } = parseHash();
  if(path === "#/detail") return setHash("#/list");
  if(path === "#/list"){
    if(state.area === "kindergarten") return setHash("#/duration");
    return setHash("#/area");
  }
  if(path === "#/duration") return setHash("#/area");
  setHash("#/area");
});

ui.btnRegenerate.addEventListener("click", ()=>{
  if(ui.btnRegenerate.disabled) return;
  state.lastListSeed = (state.lastListSeed || 0) + 1;
  saveState();
  // stays on list, just rerenders
  if((location.hash || "").startsWith("#/list")) render();
  else setHash("#/list");
});

ui.search.addEventListener("input", (e)=>{
  state.search = e.target.value || "";
  saveState();
  const { path } = parseHash();
  if(path === "#/list") renderListView();
});

ui.btnClearSearch.addEventListener("click", ()=>{
  state.search = "";
  ui.search.value = "";
  saveState();
  const { path } = parseHash();
  if(path === "#/list") renderListView();
});

window.addEventListener("hashchange", render);

/**
 * 8) Utils
 */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s); }

/**
 * Boot
 */
$("#year").textContent = new Date().getFullYear();
loadState();

// If empty hash: go to area
if(!location.hash) setHash("#/area");

// restore search input
ui.search.value = state.search || "";

// first render
render();
</script>
</body>
</html>
